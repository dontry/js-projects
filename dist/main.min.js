var $box = $("#slide-box"),
    $slide_bg = $("#slide-bg"),
    $scale_text = $(".scale_text"),
    $captcha = $(".captcha-area"),
    $btn_next = $("#btn-next"),
    $captcha_img = $(".captcha-img > img"),
    $form_mobile = $(".form-mobile"),
    $form_email = $(".form-email"),
    $reg_method = $(".reg-method"),
    method = 0,
    USE_PHONE = 0,
    USE_EMAIL = 1,
    CAPTCHA_COUNT = 3,
    CLICK_RANGE = 8,
    VALIDATED = !1;
pid = 0, slideBoxRestart = function() {
    $(document).off("mousemove"), $box.animate({
        left: "0px"
    }), $slide_bg.animate({
        width: "0px"
    })
}, showImg = function() {
    $scale_text.css("color", "#fff"), $captcha.show()
}, reloadImg = function() {
    do var t = Math.floor(100 * Math.random()) % CAPTCHA_COUNT + 1; while (t == pid);
    pid = t
}, getCaptcha = function() {
    0 === pid && (pid = Math.floor(100 * Math.random()) % CAPTCHA_COUNT + 1, $(".captcah-reload").on("click", function(){reloadImg, getCaptcha, return false));
    var t = "assets/captcha0" + pid + ".jpg",
        o = "assets/captcha0" + pid + ".json",
        e = {};
    $captcha_img.attr("src", t), $.getJSON(o, function(t) {
        console.log("get JSON: " + o);
        var i = t.count,
            n = Math.floor(100 * Math.random()) % i,
            a = t.data[n],
            c = a.value;
        e.x = a.x, e.y = a.y, $scale_text.text('请点击图中"' + c + '"字')
    }).error(function(t, o, e) {
        console.log("ERROR: " + o + ", " + e)
    }), $captcha_img.on("click", function(t) {
        checkCaptcha(t, e)
    })
}, checkCaptcha = function(t, o) {
    Math.abs(t.offsetX - o.x) <= CLICK_RANGE && Math.abs(t.offsetY - o.y) <= CLICK_RANGE ? ($(this).off("click"), captchaVerified()) : (console.log("验证码错误"), $captcha_img.off("click"), reloadImg(), getCaptcha(), $(".captcha-answer").text("验证码错误,请重试!"))
}, captchaVerified = function() {
    $captcha.hide(), $scale_text.text("验证成功"), $btn_next.removeClass("btn-disabled").addClass("btn-enabled")
}, checkValidation = function(t) {
    if (method === USE_PHONE) {
        var o = /^0?(13[0-9]|15[012356789]|18[0236789]|14[57])[0-9]{8}$/;
        o.test(t) ? VALIDATED = !0 : ($form_mobile.find(".tip").show(), VALIDATED = !1)
    } else if (method === USE_EMAIL) {
        var o = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;
        o.test(t) ? VALIDATED = !0 : ($form_email.find(".tip").show(), VALIDATED = !1)
    } else console.log("method error!"), VALIDATED = !1
}, initSlideBox = function() {
    $box.on("mousedown", function(t) {
        var o = t.clientX - this.offsetLeft;
        $(document).on("mousemove", function(t) {
            var e = t.clientX - o;
            0 > e ? e = 0 : e > 280 && (e = 280, $(document).off("mousemove").off("mouseup"), $box.off("mousedown"), showImg(), getCaptcha()), $box.css("left", e + "px"), $slide_bg.css("width", e + "px"), console.log(e + "px")
        })
    }), $(document).on("mouseup", function() {
        slideBoxRestart()
    })
}, initInputVerification = function(t) {
    var o = t.find("input");
    o.on("input", function() {
        t.find(".tip").hide()
    }).on("blur", function() {
        checkValidation(this.value)
    })
}, initRegMethod = function() {
    $reg_method.on("click", function(t) {
        t.preventDefault(), method === USE_PHONE ? (method = USE_EMAIL, $form_mobile.hide(), $form_mobile.find("input").off("blur"), $form_email.show(), $reg_method.text("需要通过手机注册")) : method === USE_EMAIL ? (method = USE_PHONE, $form_email.hide(), $form_email.find("input").off("blur"), $form_mobile.show(), $reg_method.text("需要通过邮箱注册")) : console.log("ERROR")
    })
}, initNextButton = function() {
    $("#btn-next").on("click", function() {
        VALIDATED && alert("验证成功，进入下一步！")
    })
}, $(document).ready(function() {
    initSlideBox(), initInputVerification($form_email), initInputVerification($form_mobile), initRegMethod(), initNextButton()
});
